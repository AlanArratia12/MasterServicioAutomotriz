extends layout

block content
  .hero-banner
    img(src="/images/banner.jpg" alt="Servicios Master (banner)")

  h1 Historial y búsquedas

  // ====== Filtros ======
  .card
    .grid
      // --- Fila 1: búsqueda libre + estado ---
      .col
        label(for="q") Buscar (cliente, tel, VIN)
        input#q(type="search" placeholder="Ej. Juan / 867 / Fusion / 1HGCM...")

      .col
        label(for="estado") Estado
        select#estado
          option(value="") Todos
          option(value="1") Recibido
          option(value="2") Diagnóstico
          option(value="3") En espera de refacciones
          option(value="4") Reparación
          option(value="5") Listo
          option(value="6") Entregado

      // --- Fila 2: solo activos + límite ---
      .col
        label(for="activo") Solo activos (no entregados)
        select#activo
          option(value="") No (todos)
          option(value="1") Sí

      .col
        label(for="limit") Límite por página
        select#limit
          option(value="50") 50
          option(value="100") 100
          option(value="200" selected) 200
          option(value="500") 500

      // --- Fila 3: Marca + Modelo ---
      .col
        label(for="marca") Marca
        input#marca(
          type="search"
          placeholder="Ej. Ford"
          list="lista-marca"
        )
        datalist#lista-marca

      .col
        label(for="modelo") Modelo
        input#modelo(
          type="search"
          placeholder="Ej. Mustang"
          list="lista-modelo"
        )
        datalist#lista-modelo

      // --- Fila 4: Año + Color ---
      .col
        label(for="anio") Año
        input#anio(
          type="number"
          placeholder="Ej. 2015"
          min="1950"
          max="2100"
          list="lista-anio"
        )
        datalist#lista-anio

      .col
        label(for="color") Color
        input#color(
          type="search"
          placeholder="Ej. Rojo"
          list="lista-color"
        )
        datalist#lista-color

    .actions
      button.btn#btn-aplicar(type="button") Aplicar filtros
      button.btn.secondary#btn-limpiar(type="button") Limpiar

  // ====== Tabla ======
  .cards
    .card
      h3 Resultados
      p.note Puedes abrir “Más info” para ver detalles.
      .table-responsive
        table.table#tabla-historial
          thead
            tr
              th #
              th Cliente
              th Marca / Modelo / Año / Color
              th Falla
              th Estado
              th Ingreso
              th(style="width:160px") Acciones
          tbody#historial-lista
            //- Filas generadas por /js/historial.js

      // ====== Barra de paginación ======
      .historial-pager
        .historial-pager__meta#historial-meta
        nav.historial-pager__nav#historial-paginacion

  // ================= Template de fila + panel de detalles =================
  template#tpl-historial
    // Fila principal
    tr
      td.slot-idx 1
      td.slot-cliente Juan Pérez
      td
        strong.slot-auto Nissan Altima 2017 — Negro
      td.slot-falla No enciende
      td
        span.badge.slot-estado Recibido
      td.slot-ingreso 2025-10-08 09:30
      td.actions-row
        button.btn.secondary.btn-sm.toggle-detalle(data-id="__ID__") Más info

    // Panel de detalle
    tr.row-details(hidden)
      td(colspan="7")
        .details(data-id="__ID__" hidden)

          // --------- FILA 1: CLIENTE + VEHÍCULO ---------
          .details-grid
            .details-card.details-card--cliente
              h5
                i.bi.bi-person-fill.me-1
                | Datos del cliente
              p
                strong Nombre:
                span.slot-det-cliente __CLIENTE__
              p
                strong Teléfono 1:
                span.slot-det-tel1 __TEL1__
              p
                strong Teléfono 2:
                span.slot-det-tel2 __TEL2__

            .details-card.details-card--vehiculo
              h5
                i.bi.bi-car-front-fill.me-1
                | Datos del vehículo
              p
                strong Marca:
                span.slot-det-marca __MARCA__
              p
                strong Modelo:
                span.slot-det-modelo __MODELO__
              p
                strong Año:
                span.slot-det-anio __ANIO__
              p
                strong Color:
                span.slot-det-color __COLOR__

              p.mb-1.mt-2
                strong VIN actual:
                span.slot-det-vin __VIN__
              label.form-label.mb-1(for="vin-__ID__") Capturar / editar VIN
              input.form-control.form-control-sm.vin-input(
                id="vin-__ID__"
                type="text"
                value="__VIN__"
                placeholder="Ej. 1HGCM82633A004352"
                data-id="__ID__"
              )

          // --------- FILA 2: SERVICIO ---------
          .details-grid.mt-2
            .details-card.details-card--servicio
              h5
                i.bi.bi-wrench-adjustable.me-1
                | Servicio
              p
                strong Falla reportada:
                span.slot-det-falla __FALLA__
              p.mt-2
                strong Estado actual:
                span.badge.ms-2.slot-estado Recibido

              .form-group.mt-2
                label Cambiar estado
                select.form-select.form-select-sm.estado-select(data-id="__ID__")
                  option Recibido
                  option Diagnóstico
                  option En espera de refacciones
                  option Reparación
                  option Listo
                  option Entregado

            .details-card.details-card--seguimiento
              h5
                i.bi.bi-clipboard-check.me-1
                | Seguimiento
              label Presupuesto / Cobro
              textarea.form-control.form-control-sm.cobro-input(
                rows="3"
                data-id="__ID__"
              )
              label.mt-2 Mecánico que reparó
              input.form-control.form-control-sm.mecanico-input(
                type="text"
                data-id="__ID__"
              )

          // --------- FILA 3: FOTOS ---------
          h5.mt-3
            i.bi.bi-camera-fill.me-1
            | Evidencia fotográfica
          .details-grid

            // --- IZQUIERDA: subir fotos / cámara ---
            .details-card.details-card--fotos
              .form-group.mb-2
                label(for="fotos-__ID__") Seleccionar fotos (galería)
                input.form-control.form-control-sm.fotos-input(
                  id="fotos-__ID__"
                  type="file"
                  accept="image/*"
                  multiple
                  data-id="__ID__"
                )

              .d-flex.gap-2.mb-2
                button.btn.btn-sm.cam-abrir(type="button" data-id="__ID__") Abrir cámara
                button.btn.btn-sm.cam-foto(type="button" data-id="__ID__" disabled) Tomar foto

              video.cam-preview(
                autoplay
                playsinline
                style="max-width:100%; display:none"
                data-id="__ID__"
              )

            // --- DERECHA: galería ---
            .details-card.details-card--galeria
              .fotos-grid(data-id="__ID__")
                p.text-muted.small(data-placeholder="no-fotos") Sin fotos aún.

          // ---- FOOT ----
          .details-foot.mt-3.text-end
            button.btn.btn-sm.guardar-cambios(data-id="__ID__") Guardar
            span.ms-2.text-success.small.save-ok.d-none(data-id="__ID__") Guardado ✓
            span.ms-2.text-danger.small.save-err.d-none(data-id="__ID__") Error al guardar

  script(src="/js/historial.js?v=14")
